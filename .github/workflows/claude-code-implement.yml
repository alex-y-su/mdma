name: Claude Code Implement Issue

on:
  issues:
    types: [labeled]

jobs:
  implement:
    # Only run when the 'claude' label is added
    if: github.event.label.name == 'claude'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Run Claude Code Implementation
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          model: haiku

          # Use direct_prompt for issue implementation
          direct_prompt: |
            You are implementing GitHub issue #${{ github.event.issue.number }}.

            ABSOLUTE REQUIREMENTS - NO EXCEPTIONS:

            1. First, read the FULL issue using: gh issue view ${{ github.event.issue.number }}

            2. This is an i18n task. You MUST:
               - Add `useTranslation` hook to React components
               - Replace ALL hardcoded strings with `t()` calls
               - Add translation keys to BOTH frontend/locales/ AND assets/locales/ JSON files
               - Follow the exact translation key structure provided in the issue
               - Use the Russian translations provided in the issue

            3. YOU MUST IMPLEMENT EVERY SINGLE COMPONENT LISTED IN THE ISSUE.
               - Do NOT skip components because they are "complex" or "large"
               - Do NOT suggest "follow-up tasks" for remaining work
               - Do NOT stop early or do partial work
               - Count the components in the issue and ensure you modify ALL of them
               - If the issue lists 15 components, you must modify all 15

            4. After implementing ALL changes (every single component):
               - Create a new branch: git checkout -b claude/issue-${{ github.event.issue.number }}
               - Commit all changes with a descriptive message
               - Push the branch: git push -u origin claude/issue-${{ github.event.issue.number }}

            COMPLETION CHECKLIST - ALL MUST BE TRUE:
            ✓ EVERY component file listed in the issue has been modified
            ✓ ALL translation JSON files updated (en and ru, in both frontend/locales/ and assets/locales/)
            ✓ Branch pushed to origin

            FORBIDDEN:
            ✗ Skipping components
            ✗ Partial implementations
            ✗ Suggesting "follow-up" work
            ✗ Stopping before ALL components are done

          # Allow all necessary tools
          allowed_tools: "Bash,Read,Write,Edit,Glob,Grep,WebFetch"

          # Increase max turns for larger tasks
          max_turns: 200

          # YOLO mode - skip all permission prompts
          claude_args: "--dangerously-skip-permissions"
